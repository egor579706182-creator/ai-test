
import { GoogleGenAI } from "@google/genai";
import { AnalysisFile, AnalysisMode } from "../types";

const wait = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

export const performMultimodalAnalysis = async (
  files: AnalysisFile[], 
  mode: AnalysisMode = AnalysisMode.DIAGNOSTIC,
  retryCount = 0
): Promise<string> => {
  const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

  try {
    const parts = await Promise.all(
      files.map(async (f) => {
        if (!f.base64) return null;
        return {
          inlineData: {
            mimeType: f.file.type,
            data: f.base64.split(',')[1],
          },
        };
      })
    );

    const filteredParts = parts.filter((p): p is { inlineData: { mimeType: string; data: string } } => p !== null);

    let prompt = "";

    if (mode === AnalysisMode.DIAGNOSTIC) {
      prompt = `
        Вы — высококвалифицированный клинический специалист по детскому нейроразвитию и диагностике. 
        Проанализируйте предоставленные мультимедийные данные (видео, аудио, фото и документы), чтобы выявить отклонения и нарушения развития у ребенка.
        
        КРИТИЧЕСКИЕ ИНСТРУКЦИИ:
        1. Будьте прямым, честным и объективным. НЕ сглаживайте углы. Сразу акцентируйте внимание на самых критических проблемах.
        2. ПЕРВИЧНЫЙ ФОКУС: Речь и коммуникация. Анализируйте овладение языком, навыки социального взаимодействия, совместное внимание и коммуникативные намерения.
        3. ВТОРИЧНЫЙ ФОКУС: Все остальные области развития (моторика, сенсорная обработка, когнитивные способности, стереотипное поведение и т.д.).
        4. ДОКАЗАТЕЛЬНОСТЬ: Для каждого вывода ОБЯЗАТЕЛЬНО ссылайтесь на конкретные сцены в видео (например, "На 1:15 в Видео X ребенок..."), конкретные фразы в аудио или данные из документов. Объясняйте, почему сделан такой вывод.
        5. СТИЛЬ: Профессиональный диагностический тон. 
        6. СТРУКТУРА ОТЧЕТА:
           - Анализ речи и коммуникации (Критично!)
           - Общий анализ развития (Моторика, Когнитивная сфера, Сенсорика)
           - Подробный лог доказательств (со ссылками на файлы и описанием сцен)
           - Заключение и критическое резюме
           - Список литературы и источников (DSM-5, МКБ-11 и др. стандарты)

        Предоставьте полный подробный отчет на русском языке.
      `;
    } else {
      prompt = `
        Вы — профессиональный ассистент-наблюдатель. Ваша задача — составить максимально подробный отчет о наблюдениях БЕЗ каких-либо диагностических выводов.
        
        ЗАДАЧА: Опишите подробный портрет поведения ребенка до мельчайших деталей, которые вы увидите на видео и услышите на аудио.
        
        ИНСТРУКЦИИ:
        1. Описывайте только факты: что делает ребенок, как он двигается, куда смотрит, какие звуки издает, как реагирует на окружающих.
        2. Фокусируйтесь на микро-деталях: мимика, жесты, направление взгляда, характер движений рук, интонации.
        3. КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО: Делать медицинские выводы, ставить диагнозы или использовать термины вроде "аутизм", "ЗПР", "нарушение". Просто описывайте поведение.
        4. СТРУКТУРА:
           - Описание поведения и реакций (по сценам)
           - Особенности коммуникации (физические проявления: взгляд, жесты)
           - Моторные проявления и манипуляции с предметами
           - Важные заметки о нюансах поведения
           
        Ваша цель — дать специалисту подробный "сырой" материал для его собственного анализа.
        Отчет должен быть на русском языке.
      `;
    }

    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: {
        parts: [
          ...filteredParts,
          { text: prompt }
        ]
      },
      config: {
        temperature: 0.1,
        topP: 0.95,
        topK: 40,
      }
    });

    return response.text || "Не удалось получить ответ от нейросети.";
  } catch (error: any) {
    if (error?.status === 429 || error?.message?.includes('429') || error?.message?.includes('quota')) {
      if (retryCount < 2) {
        await wait(5000 * (retryCount + 1));
        return performMultimodalAnalysis(files, mode, retryCount + 1);
      }
      throw new Error("Лимит запросов к нейросети исчерпан. Пожалуйста, подождите 1-2 минуты и попробуйте снова.");
    }
    throw error;
  }
};
